<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{.Title}}</title>
    <style>
      :root {
        --surface: rgba(255, 255, 255, 0.9);
        --surface-soft: rgba(255, 255, 255, 0.82);
        --border: rgba(15, 23, 42, 0.12);
        --text: #0f172a;
        --muted: rgba(15, 23, 42, 0.65);
        --accent: #2563eb;
        --chip-bg: rgba(37, 99, 235, 0.08);
        --chip-text: #1d4ed8;
        --metal-top: rgba(255, 255, 255, 0.9);
        --metal-mid: rgba(226, 232, 240, 0.95);
        --metal-bottom: rgba(203, 213, 225, 0.9);
        --metal-border: rgba(15, 23, 42, 0.14);
        --ease: cubic-bezier(.16,1,.3,1);
      }

      * { box-sizing: border-box; }
      html, body { height: 100%; }
      body {
        margin: 0;
        color: var(--text);
        font-family: "SF Pro Display", "SF Pro Text", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background: #eef2f8;
      }
      .chrome {
        max-width: 1200px;
        margin: 0 auto;
        padding: 38px 45px 58px;
      }
      .panel {
        border-radius: 28px;
        background: var(--surface);
        border: 1px solid var(--border);
        padding: 26px;
      }
      .hero {
        display: grid;
        grid-template-columns: 1fr;
        gap: 14px;
        align-items: start;
      }
      .searchWrap {
        display: flex;
        justify-content: center;
      }
      .search {
        width: min(860px, 100%);
        display: flex;
        gap: 10px;
        align-items: center;
        padding: 14px 16px;
        border-radius: 999px;
        background: rgba(255,255,255,0.75);
        border: 1px solid rgba(15,23,42,0.14);
      }
      #q {
        border: 0;
        outline: none;
        background: transparent;
        font-size: 1.05rem;
        width: 100%;
        color: var(--text);
      }
      #q::placeholder { color: rgba(15,23,42,0.48); }
      .helpMetaRow {
        width: min(860px, 100%);
        margin: 10px auto 0;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 12px;
        padding: 0 10px;
        position: relative;
      }
      .helpMetaRow::before {
        content: "";
        flex: 1;
      }
      .helpMeta {
        color: var(--muted);
        font-size: 0.9rem;
        font-weight: 450;
        letter-spacing: -0.01em;
        flex: 1;
        text-align: right;
      }
      .filters {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        flex-wrap: nowrap;
        max-width: 100%;
        overflow-x: auto;
        justify-content: center;
        padding: 9px 12px;
        border-radius: 999px;
        border: 1px solid var(--metal-border);
        background: linear-gradient(180deg, var(--metal-top), var(--metal-mid) 40%, var(--metal-bottom));
        box-shadow:
          0 10px 24px rgba(15, 23, 42, 0.12),
          inset 0 1px 0 rgba(255, 255, 255, 0.7),
          inset 0 -1px 0 rgba(15, 23, 42, 0.08);
        position: relative;
      }
      .filters::before {
        content: "";
        position: absolute;
        inset: 0;
        border-radius: 999px;
        background:
          radial-gradient(120% 180% at 10% 0%, rgba(255, 255, 255, 0.8), rgba(255, 255, 255, 0) 55%),
          repeating-linear-gradient(90deg, rgba(15, 23, 42, 0.025) 0 1px, rgba(255, 255, 255, 0.02) 1px 3px);
        opacity: 0.65;
        pointer-events: none;
        mix-blend-mode: overlay;
      }
      .filters > * { position: relative; z-index: 1; }
      .chip {
        appearance: none;
        border: 1px solid rgba(15, 23, 42, 0.16);
        background: linear-gradient(180deg, rgba(255,255,255,0.85), rgba(203,213,225,0.55));
        color: rgba(15, 23, 42, 0.78);
        padding: 7px 12px;
        border-radius: 999px;
        font-weight: 620;
        letter-spacing: 0.11em;
        text-transform: uppercase;
        font-size: 0.75rem;
        cursor: pointer;
        white-space: nowrap;
        transition: transform 160ms var(--ease, cubic-bezier(.16,1,.3,1)), background 160ms var(--ease, cubic-bezier(.16,1,.3,1)), border-color 160ms var(--ease, cubic-bezier(.16,1,.3,1)), color 160ms var(--ease, cubic-bezier(.16,1,.3,1));
      }
      .chip:hover { transform: translateY(-1px); }
      .chip.active {
        border-color: rgba(15, 23, 42, 0.28);
        background: linear-gradient(180deg, rgba(226,232,240,0.95), rgba(148,163,184,0.42));
        color: rgba(15, 23, 42, 0.92);
      }
      .chip:focus-visible {
        outline: 2px solid rgba(15, 23, 42, 0.6);
        outline-offset: 2px;
      }
      .layout {
        display: grid;
        grid-template-columns: 1fr;
        gap: 18px;
        margin-top: 22px;
      }
      @media (max-width: 1100px) {
        .chrome { padding: 28px 22px 52px; }
        .layout { grid-template-columns: 1fr; }
      }
      @media (max-width: 720px) {
        .helpMetaRow {
          flex-direction: column;
          align-items: center;
          padding: 0 6px;
        }
        .helpMetaRow::before { display: none; }
        .helpMeta {
          flex: none;
          text-align: center;
        }
      }
      .results {
        padding: 0;
        margin: 0;
        list-style: none;
        border-radius: 0;
        background: transparent;
        overflow: visible;
      }
      .tiles {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: nowrap;
        overflow-x: auto;
        padding: 2px 2px;
      }
      .tile {
        border-radius: 999px;
        background: rgba(255,255,255,0.72);
        border: 0;
        padding: 10px 14px;
        cursor: pointer;
        white-space: nowrap;
      }
      .tileTitle {
        font-weight: 650;
        letter-spacing: -0.01em;
        margin: 0;
      }
      .tile:focus-visible {
        outline: 2px solid rgba(37,99,235,0.65);
        outline-offset: 2px;
      }
      .resultItem {
        padding: 11px 13px;
        margin: 8px 0;
        border-radius: 20px;
        background: rgba(255,255,255,0.66);
        border: 0;
        cursor: pointer;
        position: relative;
      }
      .resultItem:last-child { margin-bottom: 0; }
      .resultItem.active {
        border-top: 2px solid rgba(37,99,235,0.55);
        border-color: rgba(15,23,42,0.12);
        background: rgba(255,255,255,0.72);
      }
      .resultItem:focus-visible {
        outline: 2px solid rgba(37,99,235,0.65);
        outline-offset: 2px;
      }
      .k {
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }
      .t {
        font-weight: 650;
        letter-spacing: -0.01em;
      }
      .s {
        color: var(--muted);
        margin-top: 6px;
        font-size: 0.92rem;
        line-height: 1.35;
        font-weight: 450;
      }
      .detail {
        margin-top: 12px;
        border-radius: 20px;
        background: rgba(255,255,255,0.65);
        border: 0;
        padding: 14px 14px;
      }
      .detail.detailFlag {
        background: rgba(15, 23, 42, 0.06);
        border: 1px solid rgba(15, 23, 42, 0.08);
      }
      .detail.detailFlag pre {
        background: rgba(15, 23, 42, 0.06);
      }
      pre {
        background: rgba(15,23,42,0.06);
        border: 0;
        border-radius: 16px;
        padding: 12px 12px;
        overflow: auto;
        font-size: 0.92rem;
        line-height: 1.35;
        margin: 12px 0 0 0;
      }
      .meta {
        color: var(--muted);
        font-size: 0.85rem;
        line-height: 1.35;
        margin-bottom: 12px;
        font-weight: 450;
      }
      .detailText {
        color: var(--text);
        font-size: 0.95rem;
        line-height: 1.45;
        font-weight: 450;
        margin-top: 8px;
      }
      .empty {
        color: var(--muted);
        padding: 16px;
        border-radius: 16px;
        border: 1px dashed rgba(15,23,42,0.18);
        background: rgba(255,255,255,0.55);
      }
    </style>
  </head>
  <body>
    <div class="chrome">
      <div class="panel">
        <div class="hero">
          <div class="searchWrap">
            <div class="search" role="search">
              <input id="q" autocomplete="off" spellcheck="false" placeholder="" />
            </div>
          </div>
          <div class="helpMetaRow" aria-label="Help filters">
            <div class="filters" role="group" aria-label="Entry type filters">
              <button class="chip active" data-kind="all" type="button">All</button>
              <button class="chip" data-kind="command" type="button">Commands</button>
              <button class="chip" data-kind="flag" type="button">Flags</button>
              <button class="chip" data-kind="env" type="button">Env</button>
            </div>
            <div class="helpMeta">{{.Version}}</div>
          </div>
        </div>

        <div class="layout" role="main">
          <div>
            <ul class="results" id="results"></ul>
          </div>
        </div>
      </div>
    </div>

    <script>
      const state = {
        index: null,
        q: "",
        kind: "all",
        results: [],
        activeId: null,
      };

      const includeAll = {{if .All}}true{{else}}false{{end}};

      const elQ = document.getElementById("q");
      const elResults = document.getElementById("results");
      const elChips = Array.from(document.querySelectorAll("[data-kind]"));

      const curated = [
        { id: "cmd:ktl apply", title: "ktl apply", sub: "Deploy a chart to a cluster" },
        { id: "cmd:ktl logs", title: "ktl logs", sub: "Tail pods fast with filtering" },
        { id: "cmd:ktl build", title: "ktl build", sub: "Build images with BuildKit workflows" },
        { id: "cmd:ktl plan", title: "ktl plan", sub: "Preview a Helm upgrade safely" },
        { id: "cmd:ktl delete", title: "ktl delete", sub: "Remove a release with a viewer" },
        { id: "cmd:ktl env", title: "ktl env", sub: "Environment variables reference" },
      ];

      function norm(s) { return (s || "").toLowerCase(); }

      function parseQuery(raw) {
        let q = (raw || "").trim();
        let kind = "all";
        const m = q.match(/(?:^|\\s)kind:(all|cmd|command|flag|env)(?:\\s|$)/i);
        if (m) {
          const v = (m[1] || "").toLowerCase();
          if (v === "flag" || v === "env" || v === "command" || v === "cmd" || v === "all") {
            kind = (v === "cmd") ? "command" : v;
          }
          q = q.replace(m[0], " ").trim();
        } else if (q.includes("--")) {
          kind = "flag";
        } else if (q.toUpperCase().includes("KTL_")) {
          kind = "env";
        }
        return { q, kind };
      }

      function score(entry, q) {
        if (!q) return 1;
        const hay = norm(entry.title + " " + (entry.subtitle || "") + " " + (entry.content || "") + " " + (entry.tags || []).join(" "));
        const needle = norm(q);
        if (hay === needle) return 1000;
        if (entry.title && norm(entry.title) === needle) return 800;
        if (entry.title && norm(entry.title).includes(needle)) return 520;
        if (hay.startsWith(needle)) return 240;
        const idx = hay.indexOf(needle);
        if (idx >= 0) return 200 - Math.min(150, idx / 10);
        return 0;
      }

      function filterAndRank() {
        if (!state.index) return [];
        const parsed = parseQuery(state.q);
        const q = parsed.q;
        const kind = parsed.kind !== "all" ? parsed.kind : state.kind;
        const scored = [];
        for (const entry of state.index.entries) {
          if (kind !== "all" && entry.kind !== kind) continue;
          const s = score(entry, q);
          if (q && s <= 0) continue;
          scored.push({ entry, s });
        }
        scored.sort((a, b) => b.s - a.s || a.entry.title.localeCompare(b.entry.title));
        if (!q) return scored.map(x => x.entry);
        return scored.slice(0, 80).map(x => x.entry);
      }

      function renderResults() {
        elResults.innerHTML = "";
        const q = state.q.trim();
        // De-dupe by kind+title as a safety net (some commands include repeated flag sets).
        const seen = new Set();
        elResults.style.display = "";
        for (const entry of state.results) {
          const key = entry.kind + ":" + entry.title;
          if (seen.has(key)) continue;
          seen.add(key);
          const li = document.createElement("li");
          li.className = "resultItem" + (entry.id === state.activeId ? " active" : "");
          li.dataset.id = entry.id;
          li.dataset.kind = entry.kind;
          const row = document.createElement("div");
          row.className = "k";
          const title = document.createElement("span");
          title.className = "t";
          title.textContent = entry.title;
          row.appendChild(title);
          li.appendChild(row);
          if (entry.id === state.activeId) {
            const detail = renderDetailInline(entry);
            if (detail) li.appendChild(detail);
          }
          li.addEventListener("click", () => select(entry.id));
          elResults.appendChild(li);
        }
        if (state.results.length === 0) {
          const li = document.createElement("li");
          li.className = "resultItem";
          li.innerHTML = '<div class="s">No matches.</div>';
          elResults.appendChild(li);
        }
      }

      function renderDetailInline(entry) {
        if (!entry) return null;
        const wrap = document.createElement("div");
        wrap.className = "detail";
        if ((entry.kind || "") === "flag") wrap.classList.add("detailFlag");
        if (entry.content) {
          const hasNewlines = entry.content.indexOf("\n") >= 0;
          if (hasNewlines) {
            const pre = document.createElement("pre");
            pre.textContent = entry.content;
            wrap.appendChild(pre);
          } else {
            const p = document.createElement("div");
            p.className = "detailText";
            p.textContent = entry.content;
            wrap.appendChild(p);
          }
        }
        if (entry.examples && entry.examples.length) {
          const pre = document.createElement("pre");
          pre.textContent = entry.examples.join("\n\n");
          wrap.appendChild(pre);
        }
        return wrap;
      }

      function select(id) {
        state.activeId = id;
        renderResults();
      }

      function onQueryChanged() {
        state.q = elQ.value || "";
        state.results = filterAndRank();
        if (state.q.trim() && state.results.length && !state.activeId) state.activeId = state.results[0].id;
        if (state.activeId && !state.results.some(e => e.id === state.activeId)) {
          state.activeId = state.results.length ? state.results[0].id : null;
        }
        renderResults();
      }

      function renderChips() {
        for (const chip of elChips) {
          chip.classList.toggle("active", (chip.dataset.kind || "all") === state.kind);
        }
      }

      function setKind(kind) {
        state.kind = kind || "all";
        renderChips();
        state.results = filterAndRank();
        if (state.activeId && !state.results.some(e => e.id === state.activeId)) {
          state.activeId = state.results.length ? state.results[0].id : null;
        }
        renderResults();
      }

      document.addEventListener("keydown", (e) => {
        if (e.key === "/" && document.activeElement !== elQ) {
          e.preventDefault();
          elQ.focus();
          return;
        }
        if (e.key === "Escape" && document.activeElement === elQ) {
          e.preventDefault();
          elQ.value = "";
          state.activeId = null;
          onQueryChanged();
        }
      });

      elQ.addEventListener("input", onQueryChanged);
      elQ.addEventListener("keydown", (e) => {
        if (e.key === "ArrowDown" || e.key === "ArrowUp") {
          e.preventDefault();
          if (!state.results.length) return;
          const idx = state.results.findIndex(e2 => e2.id === state.activeId);
          const next = e.key === "ArrowDown" ? Math.min(state.results.length - 1, idx + 1) : Math.max(0, idx - 1);
          state.activeId = state.results[next].id;
          renderResults();
        }
        if (e.key === "Enter" && state.activeId) {
          select(state.activeId);
        }
      });

      async function boot() {
        const res = await fetch(includeAll ? "/api/index.json?all=1" : "/api/index.json");
        state.index = await res.json();
        for (const chip of elChips) {
          chip.addEventListener("click", () => setKind(chip.dataset.kind || "all"));
        }
        renderChips();
        onQueryChanged();
        elQ.focus();
      }

      boot().catch(err => {
        const li = document.createElement("li");
        li.className = "resultItem";
        li.innerHTML = '<div class="s">Failed to load help index: ' + (err && err.message ? err.message : err) + '</div>';
        elResults.appendChild(li);
      });
    </script>
  </body>
</html>
