<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ktl verify report</title>
<style>
:root{color-scheme:light;--ink:#0b1f2a;--muted:rgba(11,31,42,0.62);--navy:#0b3a53;--brass:#b08d57;--surface:rgba(255,255,255,0.92);--surface-soft:rgba(255,255,255,0.84);--border:rgba(11,31,42,0.12);--shadow:0 26px 60px rgba(11,31,42,0.12);--shadow-soft:0 16px 34px rgba(11,31,42,0.10);--ease:cubic-bezier(.16,1,.3,1);} 
*{box-sizing:border-box;}body{margin:0;padding:44px 52px 72px;font-family:"SF Pro Display","SF Pro Text",-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;background:radial-gradient(1200px 700px at 18% 12%, #ffffff 0%, #eef2f7 38%, #dce3f1 100%);color:var(--ink);}h1{margin:0;font-size:2.3rem;letter-spacing:-0.03em;font-weight:650;}h2{margin:1.2rem 0 0.6rem;font-size:1.05rem;letter-spacing:0.01em;}p{margin:0.25rem 0;color:var(--muted);}a{color:var(--navy);text-decoration:none;}a:hover{text-decoration:underline;} 
.chrome{max-width:1280px;margin:0 auto;} 
.panel{background:var(--surface);border:1px solid var(--border);border-radius:26px;padding:26px 28px;box-shadow:var(--shadow);backdrop-filter:blur(18px);} 
.panel.soft{background:var(--surface-soft);box-shadow:var(--shadow-soft);} 
.layout{display:flex;gap:18px;align-items:flex-start;margin-top:16px;} 
aside{flex:0 0 320px;position:sticky;top:18px;}main{flex:1 1 auto;min-width:0;} 
.hero{display:flex;gap:16px;align-items:flex-end;justify-content:space-between;flex-wrap:wrap;} .hero>*{min-width:0;} 
.subtitle{font-size:0.98rem;color:var(--muted);overflow-wrap:anywhere;word-break:break-word;} 
.hero-right{max-width:560px;text-align:right;} 
.metrics{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-top:14px;} 
.metric{padding:14px 14px;border:1px solid rgba(11,31,42,0.10);border-radius:18px;background:rgba(255,255,255,0.55);} 
.metric .k{font-size:0.72rem;text-transform:uppercase;letter-spacing:0.18em;color:var(--muted);font-weight:650;} 
.metric .v{margin-top:6px;font-size:1.1rem;font-weight:680;overflow-wrap:anywhere;word-break:break-word;} 
.toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:14px;} 
.search{flex:1 1 320px;display:flex;align-items:center;gap:8px;background:rgba(255,255,255,0.65);border:1px solid var(--border);border-radius:999px;padding:10px 14px;box-shadow:0 0 0 rgba(0,0,0,0);} 
.search:focus-within{box-shadow:0 0 0 4px rgba(11,58,83,0.20);border-color:rgba(11,58,83,0.45);} 
.search input{border:0;outline:0;background:transparent;width:100%;font-size:0.95rem;color:var(--ink);} 
.chips{display:flex;gap:8px;flex-wrap:wrap;} 
.chip{border-radius:999px;padding:8px 12px;border:1px solid var(--border);background:rgba(255,255,255,0.55);color:var(--navy);font-size:0.72rem;text-transform:uppercase;letter-spacing:0.16em;font-weight:650;cursor:pointer;transition:transform 140ms var(--ease),box-shadow 140ms var(--ease),background 140ms var(--ease),border-color 140ms var(--ease);} 
.chip[data-on='1']{box-shadow:0 0 0 2px rgba(176,141,87,0.35);border-color:rgba(176,141,87,0.55);background:rgba(176,141,87,0.10);transform:translateY(-1px);} 
.chip.sev-critical,.chip.sev-high{color:#7f1d1d;} .chip.sev-medium{color:#7c4a00;} .chip.sev-low{color:#0c4a6e;} .chip.sev-info{color:rgba(11,31,42,0.70);} 
select,button,input{font-family:inherit;} 
.select{border:1px solid var(--border);border-radius:999px;background:rgba(255,255,255,0.55);padding:9px 12px;font-size:0.9rem;color:var(--ink);} 
.tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;} 
.tab{border-radius:999px;padding:8px 12px;border:1px solid var(--border);background:rgba(255,255,255,0.55);cursor:pointer;font-size:0.78rem;letter-spacing:0.14em;text-transform:uppercase;font-weight:650;color:var(--ink);} 
.tab[data-on='1']{border-color:rgba(176,141,87,0.55);box-shadow:0 0 0 2px rgba(176,141,87,0.30);background:rgba(176,141,87,0.10);} 
.table{width:100%;border-collapse:collapse;margin-top:10px;font-size:0.95rem;} 
.table th,.table td{padding:10px 10px;border-bottom:1px solid rgba(11,31,42,0.08);vertical-align:top;text-align:left;} 
.table th{font-size:0.72rem;text-transform:uppercase;letter-spacing:0.18em;color:var(--muted);font-weight:680;} 
.mono{font-family:"SFMono-Regular","JetBrains Mono","Menlo","Source Code Pro",monospace;font-size:0.9em;overflow-wrap:anywhere;word-break:break-word;} 
.badge{display:inline-flex;align-items:center;gap:8px;border-radius:999px;padding:4px 10px;font-size:0.72rem;text-transform:uppercase;letter-spacing:0.16em;font-weight:700;border:1px solid rgba(11,31,42,0.10);background:rgba(255,255,255,0.55);} 
.dot{width:8px;height:8px;border-radius:999px;background:rgba(11,31,42,0.35);} 
.sev-critical .dot,.sev-high .dot{background:#ef4444;} .sev-medium .dot{background:#f59e0b;} .sev-low .dot{background:#0ea5e9;} .sev-info .dot{background:rgba(11,31,42,0.35);} 
.row{cursor:pointer;} .row:hover{background:rgba(11,31,42,0.03);} 
.klist{list-style:none;padding:0;margin:10px 0 0;} .klist li{display:flex;justify-content:space-between;gap:10px;padding:8px 0;border-bottom:1px solid rgba(11,31,42,0.07);} .klist li:last-child{border-bottom:none;} 
.muted{color:var(--muted);} 
.toast{position:fixed;left:50%;bottom:22px;transform:translateX(-50%);background:rgba(11,31,42,0.92);color:#fff;padding:10px 14px;border-radius:999px;font-size:0.9rem;opacity:0;pointer-events:none;transition:opacity 160ms var(--ease);} .toast.on{opacity:1;} 
.drawer-backdrop{position:fixed;inset:0;background:rgba(11,31,42,0.28);opacity:0;pointer-events:none;transition:opacity 160ms var(--ease);} .drawer-backdrop.on{opacity:1;pointer-events:auto;} 
.drawer{position:fixed;top:0;right:0;height:100%;width:min(520px, 92vw);background:rgba(255,255,255,0.96);border-left:1px solid rgba(11,31,42,0.10);box-shadow:0 40px 90px rgba(11,31,42,0.22);transform:translateX(100%);transition:transform 220ms var(--ease);padding:20px 18px 24px;overflow:auto;} .drawer.on{transform:translateX(0);} 
.drawer h2{margin-top:0.25rem;} 
.btn{border-radius:999px;padding:9px 12px;border:1px solid rgba(11,31,42,0.16);background:rgba(255,255,255,0.70);cursor:pointer;font-weight:650;} .btn:hover{border-color:rgba(176,141,87,0.60);} 
.delta-tag{display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:3px 9px;font-size:0.68rem;text-transform:uppercase;letter-spacing:0.16em;font-weight:750;border:1px solid rgba(176,141,87,0.45);background:rgba(176,141,87,0.12);color:rgba(11,31,42,0.90);} 
.changes{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 6px;} .change{border-radius:999px;padding:6px 10px;border:1px solid rgba(11,31,42,0.10);background:rgba(255,255,255,0.55);font-size:0.7rem;text-transform:uppercase;letter-spacing:0.14em;font-weight:700;color:rgba(11,31,42,0.80);} 
.baseline-box{margin-top:12px;padding:12px 12px;border:1px solid rgba(11,31,42,0.10);border-radius:18px;background:rgba(255,255,255,0.65);} 
pre{white-space:pre-wrap;margin:10px 0 0;background:rgba(11,31,42,0.04);border:1px solid rgba(11,31,42,0.08);border-radius:16px;padding:12px 14px;overflow-wrap:anywhere;word-break:break-word;} 
body.print .toolbar,body.print aside,body.print .drawer,body.print .drawer-backdrop,body.print .toast{display:none !important;} body.print .layout{display:block;} body.print .panel{box-shadow:none;} 
@media (max-width:1100px){body{padding:26px 16px 48px;} aside{position:relative;top:auto;flex:1 1 100%;} .layout{flex-direction:column;} } 
</style>
</head>
<body>
<div class="chrome">
<div class="panel" id="hero"></div>
<div class="layout">
<aside class="panel soft" id="sidebar"></aside>
<main>
<div class="panel" id="main"></div>
</main>
</div>
</div>
<div class="drawer-backdrop" id="drawerBackdrop"></div>
<div class="drawer" id="drawer"></div>
<div class="toast" id="toast">Copied</div>
<script type="application/json" id="ktlVerifyData">{"report":{"tool":"ktl-verify","engine":{"name":"builtin","ruleset":"builtin@test"},"mode":"warn","failOn":"high","passed":true,"blocked":false,"evaluatedAt":"2026-02-06T00:00:00Z","inputs":[{"kind":"manifest","source":"rendered.yaml","renderedSha256":"abc123"}],"summary":{"total":1,"bySeverity":{"medium":1},"byRule":{"k8s/container_image_tag_latest":1},"byRuleSeverity":{"k8s/container_image_tag_latest":{"medium":1}},"passed":true,"blocked":false},"findings":[{"ruleId":"k8s/container_image_tag_latest","severity":"medium","category":"Supply Chain","message":"Image tag should not be latest","fieldPath":"spec.template.spec.containers.0.image","location":"metadata.name={{web}}.spec.template.spec.containers.name={{web}}.image","expected":"pin to tag/digest","observed":"nginx:latest","subject":{"kind":"Deployment","namespace":"default","name":"web"},"helpUrl":"https://example.invalid/docs"}]},"fixPlan":[{"kind":"Deployment","namespace":"default","name":"web","ruleId":"k8s/container_image_tag_latest","title":"Pin container images to a tag or digest","patchYaml":"apiVersion: v1\nkind: Deployment\nmetadata:\n  name: web\n  namespace: default\nspec:\n  template:\n    spec:\n  containers:\n    - name: \u003ccontainer\u003e\n      image: \u003crepo\u003e:\u003ctag\u003e\n"}],"namespaces":["default"],"topRules":[{"key":"k8s/container_image_tag_latest","count":1}],"topResources":[{"key":"default/Deployment/web","count":1}]}</script>
<script>
(function(){
  var raw = document.getElementById('ktlVerifyData');
  if(!raw){ return; }
  var data = {};
  try { data = JSON.parse(raw.textContent || '{}'); } catch(e) { data = {}; }
  var rep = (data && data.report) || {};
  var fixPlan = (data && data.fixPlan) || [];
  var namespaces = (data && data.namespaces) || [];
  var topRules = (data && data.topRules) || [];
  var topResources = (data && data.topResources) || [];
  var deltaDetailsNew = (rep && rep.delta && rep.delta.newOrChangedDetails) ? rep.delta.newOrChangedDetails : [];
  var deltaDetailsFixed = (rep && rep.delta && rep.delta.fixedDetails) ? rep.delta.fixedDetails : [];

  function qs(sel){ return document.querySelector(sel); }
  function ce(tag, cls){ var el=document.createElement(tag); if(cls){ el.className=cls; } return el; }
  function text(el, s){ el.textContent = (s==null?'':String(s)); return el; }
  function fmtRFC3339(s){ return s || ''; }
  function sevKey(s){ return (s||'info').toLowerCase(); }
  function badgeFor(sev){
    var s = sevKey(sev);
    var span = ce('span', 'badge sev-'+s);
    var dot = ce('span','dot');
    span.appendChild(dot);
    span.appendChild(text(ce('span'), s.toUpperCase()));
    return span;
  }
  function resourceKey(f){
    if(f.resourceKey){ return f.resourceKey; }
    var k = (f.subject && f.subject.kind) ? String(f.subject.kind) : '';
    var ns = (f.subject && f.subject.namespace) ? String(f.subject.namespace) : '';
    var nm = (f.subject && f.subject.name) ? String(f.subject.name) : '';
    var out = '';
    if(ns){ out += ns + '/'; }
    if(k){ out += k + '/'; }
    out += nm || '-';
    return out;
  }
  function fieldKey(f){
    var loc = (f.location || '').trim();
    var fieldPath = (f.fieldPath || '').trim();
    var base = fieldPath || loc;
    if(f.line && f.line > 0){
      if(base){ return base + ':' + f.line; }
      return String(f.line);
    }
    return base;
  }
  function isPolicy(f){ return String(f.ruleId||'').indexOf('policy/')===0; }
  function fpForFinding(f){
    // Prefer engine-computed fingerprint.
    var fp = String(f.fingerprint || '').trim();
    if(fp){ return fp; }
    // Fallback aligns with server-side fallbackFingerprint/identityKey.
    var subj = f.subject || {};
    var loc = (f.location || '').trim();
    var fieldPath = (f.fieldPath || '').trim();
    var base = fieldPath || loc;
    return [String(f.ruleId||''), String(subj.kind||''), String(subj.namespace||''), String(subj.name||''), base].join('|');
  }
  function idForFinding(f){
    var subj = f.subject || {};
    var loc = (f.location || '').trim();
    var fieldPath = (f.fieldPath || '').trim();
    var base = fieldPath || loc;
    return [String(f.ruleId||''), String(subj.kind||''), String(subj.namespace||''), String(subj.name||''), base].join('|');
  }
  function toast(msg){
    var t = qs('#toast');
    if(!t) return;
    t.textContent = msg || 'Copied';
    t.classList.add('on');
    window.clearTimeout(toast._tid);
    toast._tid = window.setTimeout(function(){ t.classList.remove('on'); }, 1200);
  }
  async function copyText(s){
    try{
      await navigator.clipboard.writeText(String(s||''));
      toast('Copied');
      return true;
    }catch(e){
      try{
        var ta=ce('textarea'); ta.value=String(s||''); document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
        toast('Copied');
        return true;
      }catch(e2){
        toast('Copy failed');
        return false;
      }
    }
  }
  function applyPrintMode(){
    var sp = new URLSearchParams(location.search||'');
    if(sp.has('print')){
      document.body.classList.add('print');
    }
  }
  function normalizeFindings(list){
    return (list||[]).map(function(f){
      var out = Object.assign({}, f);
      out._sev = sevKey(out.severity);
      out._rule = String(out.ruleId || '').trim();
      out._res = resourceKey(out);
      out._ns = (out.subject && out.subject.namespace) ? String(out.subject.namespace) : '';
      out._field = fieldKey(out);
      out._src = isPolicy(out) ? 'policy' : 'rules';
      out._fp = String(out.fingerprint || (out._rule + ':' + out._res + ':' + out._field)).trim();
      out._search = (out._rule + ' ' + out._res + ' ' + (out.message||'') + ' ' + (out.category||'') + ' ' + out._field).toLowerCase();
      // Delta narrative (new/changed/fixed) is keyed by engine fingerprint where possible.
      var dfp = fpForFinding(out);
      var did = idForFinding(out);
      var det = normalizeFindings._deltaByFP && normalizeFindings._deltaByFP[dfp] ? normalizeFindings._deltaByFP[dfp] : null;
      if(!det && normalizeFindings._deltaByID && normalizeFindings._deltaByID[did]){ det = normalizeFindings._deltaByID[did]; }
      if(det){
        out._deltaKind = String(det.kind||'').trim();
        out._deltaChanges = det.changes || [];
        out._baseline = (out._deltaKind === 'changed') ? (det.baseline || null) : null;
      }else{
        out._deltaKind = '';
        out._deltaChanges = [];
        out._baseline = null;
      }
      return out;
    });
  }
  // Precompute delta lookup maps so the UI can show a change narrative.
  (function(){
    var byFP = {};
    var byID = {};
    (deltaDetailsNew||[]).forEach(function(d){
      var cur = d.current || null;
      if(!cur) return;
      var fp = fpForFinding(cur);
      var id = idForFinding(cur);
      byFP[fp] = d;
      byID[id] = d;
    });
    (deltaDetailsFixed||[]).forEach(function(d){
      var base = d.baseline || null;
      if(!base) return;
      var fp = fpForFinding(base);
      var id = idForFinding(base);
      byFP[fp] = d;
      byID[id] = d;
    });
    normalizeFindings._deltaByFP = byFP;
    normalizeFindings._deltaByID = byID;
  })();
  var allFindings = normalizeFindings(rep.findings || []);
  var delta = rep.delta || null;
  var deltaNew = delta && delta.newOrChanged ? normalizeFindings(delta.newOrChanged) : null;
  var deltaFixed = delta && delta.fixed ? normalizeFindings(delta.fixed) : null;
  var views = [];
  if(delta){
    views = [
      {id:'new', label:'New/Changed', list: deltaNew || allFindings},
      {id:'fixed', label:'Fixed', list: deltaFixed || []},
      {id:'all', label:'All', list: (deltaNew||[]).concat(deltaFixed||[])}
    ];
  }else{
    views = [{id:'all', label:'All', list: allFindings}];
  }
  var state = {
    q: '',
    view: (delta ? 'new' : 'all'),
    groupBy: 'none',
    sev: {critical:true, high:true, medium:true, low:true, info:true},
    src: {rules:true, policy:true},
    ns: 'all',
    hideDup: false
  };
  function renderHero(){
    var hero = qs('#hero'); if(!hero) return;
    hero.innerHTML = '';
    var wrap = ce('div','hero');
    var left = ce('div');
    left.appendChild(text(ce('h1'), 'ktl verify report'));
    left.appendChild(text(ce('div','subtitle'), 'Evaluated: ' + fmtRFC3339(rep.evaluatedAt)));
    wrap.appendChild(left);
    var right = ce('div','subtitle hero-right');
    var ruleset = (rep.engine && rep.engine.ruleset) ? rep.engine.ruleset : '';
    text(right, ruleset ? ('Ruleset: ' + ruleset) : '');
    wrap.appendChild(right);
    hero.appendChild(wrap);

    var metrics = ce('div','metrics');
    function metric(k,v){
      var m=ce('div','metric');
      m.appendChild(text(ce('div','k'), k));
      m.appendChild(text(ce('div','v'), v));
      return m;
    }
    metrics.appendChild(metric('Mode', rep.mode || '-'));
    metrics.appendChild(metric('Fail On', rep.failOn || '-'));
    metrics.appendChild(metric('Passed', String(!!rep.passed)));
    metrics.appendChild(metric('Blocked', String(!!rep.blocked)));
    metrics.appendChild(metric('Total', String((rep.summary && rep.summary.total) || 0)));
    if(delta){
      metrics.appendChild(metric('Baseline', String(delta.baselineTotal || 0)));
      metrics.appendChild(metric('Unchanged', String(delta.unchanged || 0)));
    }
    hero.appendChild(metrics);
  }
  function renderSidebar(){
    var sb = qs('#sidebar'); if(!sb) return;
    sb.innerHTML = '';
    sb.appendChild(text(ce('h2'), 'Summary'));
    var bySev = (rep.summary && rep.summary.bySeverity) || {};
    var ul = ce('ul','klist');
    ['critical','high','medium','low','info'].forEach(function(s){
      var li = ce('li');
      var l = ce('span','mono');
      l.appendChild(badgeFor(s));
      li.appendChild(l);
      li.appendChild(text(ce('span','mono'), String(bySev[s] || 0)));
      ul.appendChild(li);
    });
    sb.appendChild(ul);

    sb.appendChild(text(ce('h2'), 'Top Rules'));
    var ulr = ce('ul','klist');
    (topRules||[]).forEach(function(it){
      var li=ce('li'); li.appendChild(text(ce('span','mono'), it.key)); li.appendChild(text(ce('span','mono'), it.count)); ulr.appendChild(li);
    });
    if((topRules||[]).length===0){ ulr.appendChild(text(ce('li','muted'), 'No data')); }
    sb.appendChild(ulr);

    sb.appendChild(text(ce('h2'), 'Top Resources'));
    var ulx = ce('ul','klist');
    (topResources||[]).forEach(function(it){
      var li=ce('li'); li.appendChild(text(ce('span','mono'), it.key)); li.appendChild(text(ce('span','mono'), it.count)); ulx.appendChild(li);
    });
    if((topResources||[]).length===0){ ulx.appendChild(text(ce('li','muted'), 'No data')); }
    sb.appendChild(ulx);

    sb.appendChild(text(ce('h2'), 'Inputs'));
    var inps = rep.inputs || [];
    if(inps.length===0){
      sb.appendChild(text(ce('p','muted'), 'No inputs recorded.'));
    }else{
      var uli = ce('ul','klist');
      inps.forEach(function(x){
        var li=ce('li');
        var left = ce('span');
        var kind = String(x.kind||'-');
        var src = (x.source ? (' ' + x.source) : '');
        left.appendChild(text(ce('span','mono'), kind + src));
        li.appendChild(left);
        li.appendChild(text(ce('span','mono'), (x.renderedSha256||'').slice(0,12) || '-'));
        uli.appendChild(li);
      });
      sb.appendChild(uli);
    }

    if(delta){
      sb.appendChild(text(ce('h2'), 'Review Checklist'));
      var p = ce('p','muted');
      var fixedCount = (delta.fixed && delta.fixed.length) ? delta.fixed.length : 0;
      var newCount = (delta.newOrChanged && delta.newOrChanged.length) ? delta.newOrChanged.length : 0;
      p.textContent = 'New/Changed: ' + newCount + ' · Fixed: ' + fixedCount + ' · Unchanged: ' + String(delta.unchanged || 0);
      sb.appendChild(p);

      var btn = ce('button','btn'); btn.type='button'; btn.textContent='Copy PR Summary';
      btn.onclick = function(){
        var lines = [];
        lines.push('### ktl verify');
        lines.push('');
        lines.push('- New/Changed: ' + newCount);
        lines.push('- Fixed: ' + fixedCount);
        lines.push('- Unchanged: ' + String(delta.unchanged || 0));
        if((topRules||[]).length){
          lines.push('');
          lines.push('Top rules:');
          (topRules||[]).slice(0,5).forEach(function(it){ lines.push('- ' + it.key + ' (' + it.count + ')'); });
        }
        // Surface template sources when available.
        var srcSet = {};
        (delta.newOrChanged||[]).forEach(function(f){
          var ev = f.evidence || {};
          var src = String(ev.templateSource || f.path || '').trim();
          if(src){ srcSet[src]=1; }
        });
        var srcs = Object.keys(srcSet).sort();
        if(srcs.length){
          lines.push('');
          lines.push('Touched templates/files:');
          srcs.slice(0,10).forEach(function(s){ lines.push('- ' + s); });
          if(srcs.length>10){ lines.push('- …'); }
        }
        copyText(lines.join('\\n'));
      };
      sb.appendChild(btn);
    }
  }
  function findingsForState(){
    var list = null;
    for(var i=0;i<views.length;i++){
      if(views[i].id===state.view){ list = views[i].list; break; }
    }
    if(!list){ list = allFindings; }
    var term = (state.q||'').toLowerCase().trim();
    var out = [];
    var seen = {};
    for(var j=0;j<list.length;j++){
      var f=list[j];
      if(!state.sev[f._sev]) continue;
      if(!state.src[f._src]) continue;
      if(state.ns!=='all' && f._ns!==state.ns) continue;
      if(term && f._search.indexOf(term)===-1) continue;
      if(state.hideDup){
        if(seen[f._fp]) continue;
        seen[f._fp]=1;
      }
      out.push(f);
    }
    // Keep stable ordering from Go, do not sort here.
    return out;
  }
  function group(list){
    var key = state.groupBy || 'none';
    if(key==='none'){ return [{k:'', list:list}]; }
    var m = {};
    var order = [];
    list.forEach(function(f){
      var g='';
      if(key==='rule') g=f._rule;
      else if(key==='resource') g=f._res;
      else if(key==='namespace') g=f._ns || '(cluster)';
      else if(key==='category') g=(f.category||'(uncategorized)');
      if(!m[g]){ m[g]=[]; order.push(g); }
      m[g].push(f);
    });
    return order.map(function(k){ return {k:k, list:m[k]}; });
  }
  function openDrawer(f){
    var bd = qs('#drawerBackdrop'); var dr = qs('#drawer');
    if(!bd || !dr){ return; }
    dr.innerHTML = '';
    var top = ce('div','hero');
    var title = ce('div');
    title.appendChild(text(ce('h2'), (f._rule || 'finding')));
    title.appendChild(text(ce('div','subtitle'), (f._res || '') + (f._field ? (' · ' + f._field) : '')));
    top.appendChild(title);
    var actions = ce('div','chips');
    var b1 = ce('button','btn'); text(b1,'Copy Rule'); b1.onclick=function(){ copyText(f._rule); };
    var b2 = ce('button','btn'); text(b2,'Copy Resource'); b2.onclick=function(){ copyText(f._res); };
    var b3 = ce('button','btn'); text(b3,'Copy Fingerprint'); b3.onclick=function(){ copyText(f._fp); };
    actions.appendChild(b1); actions.appendChild(b2); actions.appendChild(b3);
    top.appendChild(actions);
    dr.appendChild(top);

    var sev = ce('p'); sev.appendChild(badgeFor(f._sev)); dr.appendChild(sev);
    if(f._deltaKind){
      var tag = ce('span','delta-tag');
      tag.textContent = (f._deltaKind || '').toUpperCase();
      dr.appendChild(tag);
    }
    if(f._deltaChanges && f._deltaChanges.length){
      var ch = ce('div','changes');
      (f._deltaChanges||[]).forEach(function(c){
        var it = ce('span','change'); it.textContent = String(c).toUpperCase(); ch.appendChild(it);
      });
      dr.appendChild(ch);
    }
    if(f.message){ dr.appendChild(text(ce('p'), f.message)); }
    if(f.expected){ dr.appendChild(text(ce('div','muted'), 'Expected')); var pre=ce('pre','mono'); pre.textContent=String(f.expected); dr.appendChild(pre); }
    if(f.observed){ dr.appendChild(text(ce('div','muted'), 'Observed')); var pre2=ce('pre','mono'); pre2.textContent=String(f.observed); dr.appendChild(pre2); }
    if(f.helpUrl){ var p=ce('p'); var a=ce('a'); a.href=f.helpUrl; a.target='_blank'; a.rel='noreferrer'; a.textContent='Docs'; p.appendChild(a); dr.appendChild(p); }
    if(f.path || (f.line && f.line>0)){
      dr.appendChild(text(ce('div','muted'), 'Source'));
      var src = String(f.path||'').trim();
      if(f.line && f.line>0){ src = src ? (src + ':' + f.line) : String(f.line); }
      var ps = ce('p','mono'); ps.textContent = src || '-'; dr.appendChild(ps);
      var bsrc=ce('button','btn'); text(bsrc,'Copy Source'); bsrc.onclick=function(){ copyText(src); }; dr.appendChild(bsrc);
    }
    if(f._baseline){
      var box = ce('div','baseline-box');
      box.appendChild(text(ce('div','muted'), 'Baseline'));
      var bmsg = String(f._baseline.message || '').trim();
      if(bmsg){ box.appendChild(text(ce('p'), bmsg)); }
      var bexp = String(f._baseline.expected || '').trim();
      var bob = String(f._baseline.observed || '').trim();
      if(bexp){ box.appendChild(text(ce('div','muted'), 'Expected')); var preB=ce('pre','mono'); preB.textContent=bexp; box.appendChild(preB); }
      if(bob){ box.appendChild(text(ce('div','muted'), 'Observed')); var preB2=ce('pre','mono'); preB2.textContent=bob; box.appendChild(preB2); }
      var bsrc = String(f._baseline.path || '').trim();
      if(bsrc){ box.appendChild(text(ce('div','muted'), 'Source')); box.appendChild(text(ce('p','mono'), bsrc + (f._baseline.line ? (':' + f._baseline.line) : ''))); }
      dr.appendChild(box);
    }
    if(f.evidence){
      dr.appendChild(text(ce('div','muted'), 'Evidence'));
      var preE=ce('pre','mono');
      try{ preE.textContent = JSON.stringify(f.evidence, null, 2); }catch(e){ preE.textContent = String(f.evidence); }
      dr.appendChild(preE);
      var be=ce('button','btn'); text(be,'Copy Evidence JSON'); be.onclick=function(){ copyText(preE.textContent); }; dr.appendChild(be);
    }
    var fixes = fixPlan.filter(function(x){
      var rk = (String(x.ruleId||'').trim() === String(f.ruleId||'').trim());
      var kk = (String(x.kind||'').trim() === String(f.subject && f.subject.kind || '').trim());
      var nn = (String(x.name||'').trim() === String(f.subject && f.subject.name || '').trim());
      var ns = (String(x.namespace||'').trim() === String(f.subject && f.subject.namespace || '').trim());
      return rk && kk && nn && ns;
    });
    if(fixes.length>0){
      dr.appendChild(text(ce('div','muted'), 'Suggested patch'));
      var pre3=ce('pre','mono'); pre3.textContent=String(fixes[0].patchYaml||''); dr.appendChild(pre3);
      var bc=ce('button','btn'); text(bc,'Copy Patch'); bc.onclick=function(){ copyText(pre3.textContent); }; dr.appendChild(bc);
    }
    bd.classList.add('on');
    dr.classList.add('on');
    location.hash = 'finding=' + encodeURIComponent(f._fp);
  }
  function closeDrawer(){
    var bd = qs('#drawerBackdrop'); var dr = qs('#drawer');
    if(bd) bd.classList.remove('on');
    if(dr) dr.classList.remove('on');
  }
  function renderMain(){
    var main = qs('#main'); if(!main) return;
    main.innerHTML = '';
    var toolbar = ce('div','toolbar');
    var search = ce('div','search');
    var inp = ce('input'); inp.type='search'; inp.placeholder='Search rule, resource, message, field...'; inp.value=state.q || '';
    inp.oninput=function(){ state.q = inp.value; renderMain(); };
    search.appendChild(inp);
    toolbar.appendChild(search);

    var gb = ce('select','select');
    ['none','rule','resource','namespace','category'].forEach(function(k){
      var o=ce('option'); o.value=k; o.textContent='Group: '+k; if(state.groupBy===k){ o.selected=true; } gb.appendChild(o);
    });
    gb.onchange=function(){ state.groupBy = gb.value; renderMain(); };
    toolbar.appendChild(gb);

    var nsSel = ce('select','select');
    var o0=ce('option'); o0.value='all'; o0.textContent='Namespace: all'; nsSel.appendChild(o0);
    (namespaces||[]).forEach(function(n){ var o=ce('option'); o.value=n; o.textContent='Namespace: '+n; if(state.ns===n){ o.selected=true; } nsSel.appendChild(o); });
    nsSel.value = state.ns;
    nsSel.onchange=function(){ state.ns = nsSel.value; renderMain(); };
    toolbar.appendChild(nsSel);

    var chips = ce('div','chips');
    ['critical','high','medium','low','info'].forEach(function(s){
      var c=ce('button','chip sev-'+s); c.type='button'; c.setAttribute('data-on', state.sev[s]?'1':'0'); c.textContent=s.toUpperCase();
      c.onclick=function(){ state.sev[s]=!state.sev[s]; c.setAttribute('data-on', state.sev[s]?'1':'0'); renderMain(); };
      chips.appendChild(c);
    });
    ['rules','policy'].forEach(function(s){
      var c=ce('button','chip'); c.type='button'; c.setAttribute('data-on', state.src[s]?'1':'0'); c.textContent=s.toUpperCase();
      c.onclick=function(){ state.src[s]=!state.src[s]; c.setAttribute('data-on', state.src[s]?'1':'0'); renderMain(); };
      chips.appendChild(c);
    });
    var hd=ce('button','chip'); hd.type='button'; hd.setAttribute('data-on', state.hideDup?'1':'0'); hd.textContent='HIDE DUP';
    hd.onclick=function(){ state.hideDup=!state.hideDup; hd.setAttribute('data-on', state.hideDup?'1':'0'); renderMain(); };
    chips.appendChild(hd);
    toolbar.appendChild(chips);
    main.appendChild(toolbar);

    if(views.length > 1){
      var tabs = ce('div','tabs');
      views.forEach(function(v){
        var t=ce('button','tab'); t.type='button'; t.setAttribute('data-on', state.view===v.id?'1':'0');
        var count = (v.list||[]).length;
        t.textContent = v.label + ' ('+count+')';
        t.onclick=function(){ state.view=v.id; renderMain(); };
        tabs.appendChild(t);
      });
      main.appendChild(tabs);
    }

    var list = findingsForState();
    var groups = group(list);
    groups.forEach(function(g){
      if(g.k){
        var h = ce('h2'); text(h, g.k + ' (' + g.list.length + ')'); main.appendChild(h);
      }
      var table = ce('table','table');
      var thead = ce('thead'); var trh = ce('tr');
      ['Severity','Rule','Resource','Message','Field','Help'].forEach(function(n){ var th=ce('th'); th.textContent=n; trh.appendChild(th); });
      thead.appendChild(trh); table.appendChild(thead);
      var tbody = ce('tbody');
      g.list.forEach(function(f){
        var tr=ce('tr','row'); tr.onclick=function(){ openDrawer(f); };
        var td0=ce('td'); td0.appendChild(badgeFor(f._sev)); tr.appendChild(td0);
        tr.appendChild(text(ce('td','mono'), f._rule));
        tr.appendChild(text(ce('td','mono'), f._res));
        var msgCell = ce('td');
        if(f._deltaKind){
          var dt = ce('span','delta-tag');
          dt.textContent = (f._deltaKind || '').toUpperCase();
          msgCell.appendChild(dt);
          msgCell.appendChild(document.createTextNode(' '));
        }
        msgCell.appendChild(document.createTextNode(String(f.message || '')));
        tr.appendChild(msgCell);
        tr.appendChild(text(ce('td','mono'), f._field || ''));
        var td5=ce('td');
        if(f.helpUrl){ var a=ce('a'); a.href=f.helpUrl; a.target='_blank'; a.rel='noreferrer'; a.textContent='docs'; td5.appendChild(a); }
        else { td5.appendChild(text(ce('span','muted'), '-')); }
        tr.appendChild(td5);
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      main.appendChild(table);
    });
  }
  function wire(){
    var bd = qs('#drawerBackdrop');
    if(bd){ bd.onclick=closeDrawer; }
    window.addEventListener('keydown', function(e){ if(e.key==='Escape'){ closeDrawer(); } });
    function tryOpenFromHash(){
      var h = String(location.hash||'').replace(/^#/, '');
      if(h.indexOf('finding=')!==0) return;
      var fp = decodeURIComponent(h.slice('finding='.length));
      var all = allFindings.concat(deltaFixed||[]);
      for(var i=0;i<all.length;i++){
        if(all[i]._fp===fp){ openDrawer(all[i]); return; }
      }
    }
    tryOpenFromHash();
  }
  applyPrintMode();
  renderHero();
  renderSidebar();
  renderMain();
  wire();
})();
</script>
</body>
</html>
