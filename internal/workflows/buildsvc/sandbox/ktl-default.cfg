# ktl default sandbox config for Docker/BuildKit workloads
#
# The CLI binds your build context, builder socket, cache dir, and docker.sock
# at runtime. This policy adds user namespaces, CPU/memory caps, tmpfs-backed
# scratch space, and preserves enough host state (network + CA bundles) for
# BuildKit to pull base images and push results.

name: "ktl-build"
hostname: "ktl-build"
description: "Sandboxed ktl build session"
mode: EXECVE
cwd: "/workspace"
time_limit: 0

clone_newuts: true
clone_newipc: true
clone_newcgroup: false
clone_newpid: false
clone_newuser: false
# keep host networking for registry/Docker access
clone_newnet: false

# 8 GiB virtual address space
rlimit_as: 8388608
rlimit_cpu: 900
# 1 GiB artifacts/logs
rlimit_fsize: 1073741824
rlimit_nofile: 131072
rlimit_core: 0
rlimit_nproc: 4096
rlimit_nproc_type: VALUE

keep_env: true
keep_caps: true

# NOTE: Some nsjail builds ship with a restrictive default seccomp profile that
# breaks Go binaries (thread creation) even when no policy is specified.
# Explicitly default to ALLOW so ktl can execute reliably inside the jail.
seccomp_string: "DEFAULT ALLOW"

mount {
	dst: "/"
	fstype: "tmpfs"
	rw: true
}

mount {
	dst: "/proc"
	fstype: "proc"
}

mount {
	dst: "/tmp"
	fstype: "tmpfs"
	rw: true
	options: "size=2G"
}

mount {
	dst: "/run"
	fstype: "tmpfs"
	rw: true
	options: "size=128M"
}

mount {
	src: "/etc/resolv.conf"
	dst: "/etc/resolv.conf"
	is_bind: true
}

mount {
	src: "/etc/hosts"
	dst: "/etc/hosts"
	is_bind: true
}

mount {
	src: "/etc/ssl/certs"
	dst: "/etc/ssl/certs"
	is_bind: true
}

mount {
	src: "/usr/share/ca-certificates"
	dst: "/usr/share/ca-certificates"
	is_bind: true
}

mount {
	src: "/dev"
	dst: "/dev"
	is_bind: true
	rw: true
}

mount {
	src: "/dev/shm"
	dst: "/dev/shm"
	is_bind: true
	rw: true
}
