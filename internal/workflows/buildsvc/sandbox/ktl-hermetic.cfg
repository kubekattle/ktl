# ktl hermetic sandbox config for Docker/BuildKit workloads (nsjail)
#
# Goal: a reproducible-by-default profile for `ktl build --hermetic`:
# - Network namespace isolation (no egress by default).
# - Minimal host surface similar to the default policy.
#
# Notes:
# - ktl will bind the build context, cache dir, builder socket, and any explicit
#   `--sandbox-bind` mounts at runtime.
# - Builds that require downloads must opt in via `ktl build --hermetic --allow-network`.

name: "ktl-build-hermetic"
hostname: "ktl-build"
description: "Hermetic sandboxed ktl build session (no network egress)"
mode: EXECVE
cwd: "/workspace"
time_limit: 0

clone_newuts: true
clone_newipc: true
clone_newcgroup: false
clone_newpid: false
clone_newuser: false
clone_newnet: true

rlimit_as: 8388608
rlimit_cpu: 900
rlimit_fsize: 1073741824
rlimit_nofile: 131072
rlimit_core: 0
rlimit_nproc: 4096
rlimit_nproc_type: VALUE

keep_env: true
keep_caps: true

seccomp_string: "DEFAULT ALLOW"

mount {
	dst: "/"
	fstype: "tmpfs"
	rw: true
}

mount {
	dst: "/proc"
	fstype: "proc"
}

mount {
	dst: "/tmp"
	fstype: "tmpfs"
	rw: true
	options: "size=2G"
}

mount {
	dst: "/run"
	fstype: "tmpfs"
	rw: true
	options: "size=128M"
}

mount {
	src: "/etc/resolv.conf"
	dst: "/etc/resolv.conf"
	is_bind: true
}

mount {
	src: "/etc/hosts"
	dst: "/etc/hosts"
	is_bind: true
}

mount {
	src: "/etc/ssl/certs"
	dst: "/etc/ssl/certs"
	is_bind: true
}

mount {
	src: "/usr/share/ca-certificates"
	dst: "/usr/share/ca-certificates"
	is_bind: true
}

mount {
	src: "/dev"
	dst: "/dev"
	is_bind: true
	rw: true
}

mount {
	src: "/dev/shm"
	dst: "/dev/shm"
	is_bind: true
	rw: true
}
