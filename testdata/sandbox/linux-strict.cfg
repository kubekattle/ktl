# ktl strict sandbox config for Docker/BuildKit workloads (nsjail)
#
# Goal: a "secure-by-default" policy that demonstrates how ktl's sandbox can
# reduce host exposure during `ktl build` re-exec.
#
# Notes / expectations:
# - ktl will bind the build context, cache dir, builder socket, and any explicit
#   `--sandbox-bind` mounts at runtime.
# - This policy drops Linux capabilities. Environment variables are preserved for
#   compatibility (e.g. DOCKER_CONFIG for --authfile); avoid exporting secrets you
#   don't want available to the build process.
# - Some hosts require sysadmin tweaks for user namespaces; if `clone_newuser`
#   fails, fall back to testdata/sandbox/linux-ci.cfg.

name: "ktl-build-strict"
hostname: "ktl-build"
description: "Strict sandboxed ktl build session"
mode: EXECVE
cwd: "/workspace"
time_limit: 0

clone_newuts: true
clone_newipc: true
clone_newpid: true
clone_newcgroup: true
clone_newuser: true
# Networking is kept on the host namespace for compatibility with registry/Docker access.
# For a fully isolated network namespace, additional nsjail networking setup is required.
clone_newnet: false

# Resource ceilings (tighten as needed per environment).
rlimit_as: 8388608
rlimit_cpu: 900
rlimit_fsize: 1073741824
rlimit_nofile: 131072
rlimit_core: 0
rlimit_nproc: 2048
rlimit_nproc_type: VALUE

# Hardened defaults.
keep_caps: false

# NOTE: Some nsjail builds ship with a restrictive default seccomp profile that
# breaks Go binaries (thread creation) even when no policy is specified.
seccomp_string: "DEFAULT ALLOW"

mount {
	dst: "/"
	fstype: "tmpfs"
	rw: true
}

mount {
	dst: "/proc"
	fstype: "proc"
}

# Avoid binding sysfs in strict mode; it increases host surface area.
# mount { dst: "/sys" fstype: "sysfs" }

mount {
	dst: "/tmp"
	fstype: "tmpfs"
	rw: true
	options: "size=2G"
}

mount {
	dst: "/run"
	fstype: "tmpfs"
	rw: true
	options: "size=128M"
}

# DNS + trust store (read-only).
mount {
	src: "/etc/resolv.conf"
	dst: "/etc/resolv.conf"
	is_bind: true
}

mount {
	src: "/etc/hosts"
	dst: "/etc/hosts"
	is_bind: true
}

mount {
	src: "/etc/ssl/certs"
	dst: "/etc/ssl/certs"
	is_bind: true
}

mount {
	src: "/usr/share/ca-certificates"
	dst: "/usr/share/ca-certificates"
	is_bind: true
}

keep_env: true

# /dev: keep the host bind for compatibility with common tooling.
mount {
	src: "/dev"
	dst: "/dev"
	is_bind: true
	rw: true
}

mount {
	src: "/dev/shm"
	dst: "/dev/shm"
	is_bind: true
	rw: true
}
