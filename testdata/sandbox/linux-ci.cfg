# ktl sandbox profile for the linux-ci builders.
# Copy of the default policy with higher tmpfs budgets and explicit name/hostname
# so CI logs clearly call out which profile was used. Keep this file versioned and
# referenced through KTL_SANDBOX_CONFIG so contributors can reuse the same limits
# locally before pushing.

name: "ktl-build-linux-ci"
hostname: "ktl-linux-ci"
description: "Sandboxed ktl build session on linux-ci builders"
mode: EXECVE
cwd: "/workspace"
time_limit: 0

clone_newuts: true
clone_newipc: true
clone_newcgroup: false
clone_newpid: false
clone_newuser: false
clone_newnet: false

# 16 GiB virtual address space for concurrent builds
rlimit_as: 16777216
# rlimit_cpu=0 means "no CPU time allowed" (kills the process). Use a very high
# ceiling instead; the builder fleet should enforce quotas via cgroups.
rlimit_cpu: 86400
# 2 GiB artifacts/logs
rlimit_fsize: 2147483648
rlimit_nofile: 131072
rlimit_core: 0
rlimit_nproc: 4096
rlimit_nproc_type: VALUE

keep_env: true
keep_caps: true

# NOTE: Some nsjail builds ship with a restrictive default seccomp profile that
# breaks Go binaries (thread creation) even when no policy is specified.
seccomp_string: "DEFAULT ALLOW"

mount {
    dst: "/"
    fstype: "tmpfs"
    rw: true
}

mount {
    dst: "/proc"
    fstype: "proc"
}

mount {
    dst: "/tmp"
    fstype: "tmpfs"
    rw: true
    options: "size=4G"
}

mount {
    dst: "/run"
    fstype: "tmpfs"
    rw: true
    options: "size=256M"
}

mount {
    src: "/etc/resolv.conf"
    dst: "/etc/resolv.conf"
    is_bind: true
}

mount {
    src: "/etc/hosts"
    dst: "/etc/hosts"
    is_bind: true
}

mount {
    src: "/etc/ssl/certs"
    dst: "/etc/ssl/certs"
    is_bind: true
}

mount {
    src: "/usr/share/ca-certificates"
    dst: "/usr/share/ca-certificates"
    is_bind: true
}

mount {
    src: "/dev"
    dst: "/dev"
    is_bind: true
    rw: true
}

mount {
    src: "/dev/shm"
    dst: "/dev/shm"
    is_bind: true
    rw: true
}
